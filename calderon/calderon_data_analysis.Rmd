---
title: "Embryogenesis continuum -- Calderon et al. 2022"
subtitle: "Playing with Seurat data"
author: "TS O'Leary"
date: 'September 23, 2022'
output:
  rmarkdown::html_document:
    theme: sandstone
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
# Don't show echos, warnings, or messages
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE,
                      comment = "")
```

# **scRNA data**

## Load packages and data

```{r}
# Load packages
require(tidyverse)
require(Seurat)
require(SingleR)

# Load data
dat <- readRDS(here::here("calderon/data/main.Rds"))
```

## Data structure of Seurat object

```{r}
# Class
class(dat)

# Structure of data
str(dat)

# Peak at the data
head(dat)

# Print dimensions
# Rows = genes; columns = cells
dim(dat)
```

## Metadata per cell
```{r}
# Metadata of each cell
glimpse(dat@meta.data)

# Number of cells per experiment
dat@meta.data %>% 
  dplyr::count(orig.ident)

# Number of cells per time window
dat@meta.data %>% 
  dplyr::count(time)

# Number of cells in each time window
dat@meta.data %>%
  dplyr::count(seurat_clusters)
```

## Visualize clusters

```{r}
# UMAP with clusters labeled with number
DimPlot(dat, 
        label = TRUE)
```

## Subset data 5 - 6 hr embryos

```{r, eval = FALSE}
# Subset the data to between 5 and 6 hours according to the NNv1 model
# Remove the old features in the dat object from the dat_5
# Slim down Seurat object so it doesn't carry over the dat from all data
dat_5 <- DietSeurat(subset(dat, NNv1_age > 5 & NNv1_age < 6))
```

### Make new UMAP

Need to re-scale and re-cluster etc. when subsetted to create a new UMAP. See the functions below.

```{r, eval = FALSE}
# Scales and centers the data of just the subset dat_5
dat_5 <- ScaleData(FindVariableFeatures(NormalizeData(dat_5), 
                                        selection.method = 'vst'))

# Returns PCA -- uses pc.genes 2000 variable features -- need to look into 
#   the pc.genes and VariableFeatures more
# Output in dat_5@reductions$pca
dat_5 <- RunPCA(dat_5, 
                pc.genes = VariableFeatures(dat_5))

# Returns UMAP
# Output in dat_5@reductions$umap
dat_5 <- RunUMAP(dat_5, 
                 dims = 1:50, 
                 n.neighbors = 10, 
                 n.components = 2)

# Nearest-neighbor graph construction
# Output in dat_5@graphs$RNA_nn; dat_5@graphs$RNA_snn
dat_5 <- FindNeighbors(dat_5, 
                       reduction = "umap", 
                       dims = 1:2)

# Identify Clusters of cells -- need to calculate the K-nearest neighbors first
# Output in seurat_clusters metadata
dat_5 <- FindClusters(dat_5, 
                      resolution = 0.08)
```

### Plot new UMAP

```{r, eval = FALSE, echo = FALSE}
# Save dat_5
saveRDS(dat_5, here::here("calderon/data/dat_5.rds"))
```

```{r, echo = FALSE}
# Read in dat_5
dat_5 <- readRDS(here::here("calderon/data/dat_5.rds"))
```

```{r}
DimPlot(dat_5)
```

## Find all marker genes of each cluster

```{r, eval = FALSE}
# Find the markers for each cluster
dat_5_markers <- FindAllMarkers(dat_5,
                                only.pos = TRUE, 
                                min.pct = 0.25, 
                                logfc.threshold = 0.25)
# Save just the top 10 markers
top_10_markers <- dat_5_markers %>%
    group_by(cluster) %>%
    slice_max(n = 10, 
              order_by = avg_log2FC)
```

```{r, eval = FALSE, echo = FALSE}
saveRDS(top_10_markers, here::here("calderon/data/top_10_markers.rds"))
```

```{r, echo = FALSE}
top_10_markers <- readRDS(here::here("calderon/data/top_10_markers.rds"))
```

```{r}
# Print out the top 2 markers just to look at
top_10_markers %>%
  slice_max(n = 2, 
            order_by = avg_log2FC) %>%
  select(gene, everything())
```

# **Differential expression analysis**

Trying differential expression in 5 hr embryos vs. 6 hr embryos.

## Integrate the data sets

```{r, eval = FALSE}
# Create data subset and clear other info
dat_5 <- DietSeurat(subset(dat, NNv1_age > 5.45 & NNv1_age < 5.55))
dat_10 <- DietSeurat(subset(dat, NNv1_age > 10.1 & NNv1_age < 10.9))

# Perform integration
dat_anchors <- FindIntegrationAnchors(object.list = list(dat_5, dat_10), 
                                      dims = 1:20)
dat_comb <- IntegrateData(anchorset = dat_anchors,
                          dims = 1:20)
```

## Perform an integrated analysis

```{r, eval = FALSE}
# Set default to integrated
DefaultAssay(dat_comb) <- "integrated"

# Run the standard workflow for visualization and clustering
dat_comb <- ScaleData(dat_comb, verbose = FALSE)
dat_comb <- RunPCA(dat_comb, npcs = 30, verbose = FALSE)

# t-SNE and Clustering
dat_comb <- RunUMAP(dat_comb, reduction = "pca", dims = 1:20)
dat_comb <- FindNeighbors(dat_comb, reduction = "pca", dims = 1:20)
dat_comb <- FindClusters(dat_comb, resolution = 0.5)

# Split the data by the two time windows for plotting
# Not sure if this info exists somewhere else?
dat_comb@meta.data <- dat_comb@meta.data %>%
  mutate(time = ifelse(NNv1_age < 6, "5", "10"))
```

```{r, eval = FALSE, echo = FALSE}
saveRDS(dat_comb, here::here("calderon/data/dat_comb.rds"))
```

```{r, echo = FALSE}
dat_comb <- readRDS(here::here("calderon/data/dat_comb.rds"))
```

```{r}
DimPlot(dat_comb,
        group.by = "time")

DimPlot(dat_comb,
        label = TRUE)

DimPlot(dat_comb,
        split.by = "time")
```

# Counts

```{r}
# Number of cells per time window
dat_comb@meta.data %>% 
  dplyr::count(time)

# Number of cells in cluster
dat_comb@meta.data %>%
  dplyr::count(seurat_clusters)

# Number of cells per time window and cluster
dat_comb@meta.data %>% 
  dplyr::count(time, seurat_clusters) %>%
  pivot_wider(values_from = n,
              names_from = time)
```

```{r}
# Plot the number of cells in each cluster
dat_comb@meta.data %>% 
  dplyr::count(time, seurat_clusters) %>%
  mutate(time = fct_relevel(time, c("5", "10"))) %>%
  ggplot() +
  geom_col(aes(x = seurat_clusters,
               y = n,
               fill = time),
           position = "dodge") +
  scale_fill_manual(values = c("#888888", "#444444")) +
  theme_minimal()
```


## Differential expression between clusters

```{r, eval = FALSE}
# Set default assay back to RNA
DefaultAssay(dat_comb) <- "RNA"

# Find the conserved markers between conditions ----

# Initialize list to save markers for each cluster comparison
markers_all <- list()

# Loop through all clusters to find markers in each cluster
for (i in levels(dat_comb$seurat_clusters)) {
  # Find the conserved markers between 5 hr and 10 hr embryos
  marker <- FindConservedMarkers(dat_comb,
                                 ident.1 = i,
                                 grouping.var = "time",
                                 verbose = FALSE)
  # Save markers in the list
  markers_all[[i]] <- marker
}

# Combine into a single data_frame
dat_comb_cluster_degs <- bind_rows(markers_all, .id = "cluster")
```

```{r, eval = FALSE, echo = FALSE}
# Save dat_comb_cluster_degs
saveRDS(dat_comb_cluster_degs, 
        here::here("calderon/data/dat_comb_cluster_degs_5_10.rds"))
```

```{r, echo = FALSE}
# Save dat_comb_cluster_degs
dat_comb_cluster_degs <- 
  readRDS(here::here("calderon/data/dat_comb_cluster_degs_5_10.rds"))
```

```{r}
# Count the number of DEGs per cluster
dat_comb_cluster_degs %>%
  group_by(cluster) %>%
  tally() %>%
  arrange(desc(n))
```

## Annotation of cell types and tissues

> For cluster annotation, we used the Berkeley Drosophila Genome Project (BDGP) database,
which includes gene expression patterns of approximately 8600 genes in drosophila staged
embryos as detected by in situ hybridization (20, 21, 58). The BDGP database gives a stagespecific expression pattern (“term”) for each tested gene during embryogenesis. We used Fisher’s
test to look for enrichment of BDGP gene expression terms in each cluster’s marker genes. Top
ten terms per cluster were examined. To pick a specific term out of the top ten, we further examined
the BDGP terms of the top 20 marker genes for each cluster.

However, there do seem to be resources out there to automate the annotation process. For example, [`SingleR`](http://bioconductor.org/books/release/SingleRBook/).

### Annotations from Calderon RNA-Seq data

```{r}
# This meta data has the annotations for each cell
rna_meta <- readRDS(here::here("calderon/data/rna_meta.rds"))
colnames(rna_meta)

# Added information in the rna_meta data
setdiff(colnames(rna_meta), colnames(dat@meta.data))

# List of the manual annotations
unique(rna_meta$germ_layer)
unique(rna_meta$manual_annot)
```

## `SingleR` for annotation of cells

```{r}
# Establish a reference object from the Calderon data

# Need to create a SummarizedExperiment object from dat object
# Add the rna_meta annotations from the Calderon data
dat@meta.data$manual_annot <- rna_meta$manual_annot
dat@meta.data$germ_layer <- rna_meta$germ_layer
```

```{r, eval = FALSE}
# Create reference data set -- use just 7 hour embryos to annotate 
ref_sce <- as.SingleCellExperiment(DietSeurat(subset(dat, NNv1_age > 7 & 
                                                       NNv1_age < 8)))
ref_sce <- scuttle::logNormCounts(ref_sce)
```


```{r, eval = FALSE}
# Convert to a single cell experiment object for annotations
sce_comb <- as.SingleCellExperiment(DietSeurat(dat_comb))

# Create logNormCounts for data
sce_comb <- scuttle::logNormCounts(sce_comb)
```

Create annotation labels for each cell with `SingleR`.

```{r, eval = FALSE}
# Run SingleR to create annotation labels for each cell
annot <- SingleR(test = sce_comb,
                 assay.type.test = 1,
                 ref = ref_sce,
                 labels = ref_sce$manual_annot)
```

```{r, echo = FALSE}
# SingleR took ~ 1 hr to run so saved this as an annot file to load later
# Should consider scheduling this through slurm next time
# saveRDS(annot, here::here("calderon/data/tso_annot_sce_comb.rds"))

# Load annot data
annot <- readRDS(here::here("calderon/data/tso_annot_sce_comb.rds"))
```

### Check annotations

```{r}
# Annotation diagnostics
plotScoreHeatmap(annot)
```

```{r, eval = FALSE}
# Set the annotations back in the Seurat object for later
dat_comb@meta.data$annot <- annot$pruned.labels
```

```{r}
# Count the number of cells in each annotation
dat_comb@meta.data %>%
  group_by(time, annot) %>%
  tally() %>%
  pivot_wider(values_from = n,
              names_from = time) %>%
  arrange(desc(`5`)) %>%
  select(annot, `5`, `10`) %>%
  print(n = 37)
```

```{r}
# Plot all the annotations on a UMAP for 5 and 10 hour embryos
DimPlot(dat_comb,
        group.by = "annot",
        split.by = "time")
```


<!-- # **ATAC-Seq data** -->

<!-- ```{r} -->
<!-- atac <- readRDS(here::here("calderon/data/exp1_hrs03-07_b1_gene_activity_counts.rds")) -->
<!-- ``` -->

<!-- ## Data structure of Seurat object -->

<!-- ```{r} -->
<!-- # Class -->
<!-- class(atac) -->

<!-- # Structure of data -->
<!-- str(atac) -->

<!-- # Peak at the data -->
<!-- head(atac) -->

<!-- # Print dimensions -->
<!-- # Rows = genes; columns = cells -->
<!-- dim(atac) -->
<!-- ``` -->

<!-- ## Metadata per cell -->
<!-- ```{r} -->
<!-- # metadata -->
<!-- ``` -->



<!-- # Add more stuff -->

<!-- Other things to try: -->

<!-- - Try RNA-Seq quality control filtering etc. -->
<!-- - See the number of genes that meet the 0.02 count per per cell for differential expression per Joe Boyd -->
<!-- - ATAC-Seq data -->


